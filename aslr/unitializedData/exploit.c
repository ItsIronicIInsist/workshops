#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>

int getUserInput();
void menu();
void allocate();
void delete();
void view();
int findFreeIdx();
void allocatePointers();
void allocateGaps();

unsigned long * chunks[0x10];

struct Gaps {
	char character;      // 1byte long, 1 byte alignment
						 // 7 bytes paddiung 
	unsigned long data;  // 8 bytes, 8 byet alignemnt
};

int main() {
	while (true) {
		menu();
		
		int choice;
		scanf("%d\n", &choice);
		printf("You selected: %d\n", choice);

		switch(choice) {
			case 1:
				allocate();
				break;
			case 2:
				delete();
				break;
			case 3:
				view();
				break;
			case 4:
				allocatePointers();
				break;
			case 5:
				allocateGaps();
				break;
			default:
				puts("Invalid choice.");
				break;
		}
	}
}

int getUserInput() {
	char buf[0x10];

	fgets(buf, 0xf, stdin);
	return atoi(buf);
}

void menu() {
	puts("1. Allocate");
	puts("2. Delete");
	puts("3. View");
	puts("4. Allocate pointers");
	puts("5. Allocate gaps");
}

void allocate() {
	puts("What size?");
	int size = getUserInput();

	unsigned long * chunk = malloc(size);

	int nextFreeIndex = findFreeIdx();
	if (nextFreeIndex == -1)
		puts("No remaining spaces in table");

	chunks[nextFreeIndex] = chunk;
}

void delete() {
	puts("What index?");
	int idx = getUserInput();

	free(chunks[idx]);
}

void view() {
	puts("What index?");
	int idx = getUserInput();

	puts("How many qwords?");
	int len = getUserInput();

	for(int i = 0 ; i < len ; i++) {
		printf("%p\n", chunks[idx][i]);
	}

}

int findFreeIdx() {
	for (int i = 0 ; i < 0x10 ; i++) {
		if (chunks[i] == NULL) {
			return i;
		}
	}
	return -1;
}

// Pretend this is a struct
void allocatePointers() {
	unsigned long * chunk = malloc(0x10);

	chunk[0] = puts;
	chunk[1] = chunk;

	int nextFreeIndex = findFreeIdx();
	if (nextFreeIndex == -1)
		puts("No remaining spaces in table");

	chunks[nextFreeIndex] = chunk;
}

void allocateGaps() {
	struct Gaps * chunk = malloc(sizeof(struct Gaps));
	chunk->character = 'x';
	chunk->data = 10;

	int nextFreeIndex = findFreeIdx();
	if (nextFreeIndex == -1)
		puts("No remaining spaces in table");

	chunks[nextFreeIndex] = (unsigned long*) chunk;
}
